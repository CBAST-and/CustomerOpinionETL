@page
@model CustomerOpinionETL.Dashboard.Pages.IndexModel
@{
    ViewData["Title"] = "Dashboard de Opiniones";
}

<!-- Estilos CSS -->
<style>
    :root {
        --primary: #3b82f6;
        --success: #10b981;
        --warning: #f59e0b;
        --danger: #ef4444;
        --dark: #1f2937;
        --light: #f3f4f6;
    }

    body {
        background-color: #f9fafb;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 1rem;
    }

    .filter-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .badge-positive { background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
    .badge-negative { background: #fee2e2; color: #991b1b; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }
    .badge-neutral { background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 600; }

    .recent-opinion {
        background: #f9fafb;
        border-left: 4px solid var(--primary);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: 0.5rem;
    }

    .btn-filter {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.625rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-filter:hover {
        background: #2563eb;
        transform: translateY(-1px);
    }

    .btn-clear {
        background: #6b7280;
        color: white;
        border: none;
        padding: 0.625rem 1.5rem;
        border-radius: 0.5rem;
        font-weight: 500;
    }

    .icon-stat {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    canvas {
        max-height: 400px;
    }
</style>

<!-- Header -->
<div class="dashboard-header">
    <div class="container">
        <h1 class="display-4 fw-bold mb-2">📊 Dashboard de Análisis de Opiniones</h1>
        <p class="lead mb-0">Sistema ETL - Customer Opinion Analytics</p>
    </div>
</div>

<div class="container-fluid px-4">

    <!-- Filtros -->
    <div class="filter-card">
        <h5 class="mb-3">🔍 Filtros</h5>
        <form method="get">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" class="form-control" asp-for="StartDate" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" class="form-control" asp-for="EndDate" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Categoría</label>
                    <select class="form-select" asp-for="Categoria">
                        <option value="">Todas</option>
                        @foreach (var cat in Model.Categories)
                        {
                            <option value="@cat.Categoria">@cat.Categoria (@cat.Count)</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fuente</label>
                    <select class="form-select" asp-for="Fuente">
                        <option value="">Todas</option>
                        @foreach (var src in Model.Sources)
                        {
                            <option value="@src.NombreFuente">@src.NombreFuente (@src.Count)</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Clasificación</label>
                    <select class="form-select" asp-for="Clasificacion">
                        <option value="">Todas</option>
                        <option value="Positiva">Positiva</option>
                        <option value="Negativa">Negativa</option>
                        <option value="Neutral">Neutral</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-filter">Aplicar Filtros</button>
                <a href="/" class="btn btn-clear ms-2">Limpiar</a>
            </div>
        </form>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-stat">💬</div>
                <div class="stat-label">Total Opiniones</div>
                <div class="stat-number text-primary">@Model.DashboardData.GeneralStats.TotalOpinions.ToString("N0")</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-stat">😊</div>
                <div class="stat-label">Satisfacción Promedio</div>
                <div class="stat-number text-success">@Model.DashboardData.GeneralStats.AverageSatisfaction.ToString("0.00")</div>
                <small class="text-muted">de 5.00</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-stat">👥</div>
                <div class="stat-label">Total Clientes</div>
                <div class="stat-number text-info">@Model.DashboardData.GeneralStats.TotalCustomers.ToString("N0")</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="icon-stat">📦</div>
                <div class="stat-label">Total Productos</div>
                <div class="stat-number text-warning">@Model.DashboardData.GeneralStats.TotalProducts.ToString("N0")</div>
            </div>
        </div>
    </div>

    <!-- Gráficos Principales -->
    <div class="row">
        <!-- Distribución de Sentimientos -->
        <div class="col-md-4 mb-4">
            <div class="chart-container">
                <h5 class="chart-title">Distribución de Sentimientos</h5>
                <canvas id="sentimentPieChart"></canvas>
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge-positive">✓ Positivas: @Model.DashboardData.GeneralStats.PositiveOpinions</span>
                        <span>@Model.DashboardData.SentimentDistribution.FirstOrDefault(s => s.Clasificacion == "Positiva")?.Porcentaje.ToString("0.0")%</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="badge-negative">✗ Negativas: @Model.DashboardData.GeneralStats.NegativeOpinions</span>
                        <span>@Model.DashboardData.SentimentDistribution.FirstOrDefault(s => s.Clasificacion == "Negativa")?.Porcentaje.ToString("0.0")%</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="badge-neutral">○ Neutrales: @Model.DashboardData.GeneralStats.NeutralOpinions</span>
                        <span>@Model.DashboardData.SentimentDistribution.FirstOrDefault(s => s.Clasificacion == "Neutral")?.Porcentaje.ToString("0.0")%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tendencia Mensual -->
        <div class="col-md-8 mb-4">
            <div class="chart-container">
                <h5 class="chart-title">Tendencia de Satisfacción Mensual</h5>
                <canvas id="trendLineChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Opiniones por Fuente -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <h5 class="chart-title">Opiniones por Fuente de Datos</h5>
                <canvas id="sourceBarChart"></canvas>
            </div>
        </div>

        <!-- Top Productos -->
        <div class="col-md-6 mb-4">
            <div class="chart-container">
                <h5 class="chart-title">Top 10 Productos por Satisfacción</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Categoría</th>
                                <th class="text-center">Opiniones</th>
                                <th class="text-center">Promedio</th>
                                <th class="text-center">% Positivo</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var product in Model.DashboardData.TopProducts.Take(10))
                            {
                                <tr>
                                    <td><strong>@product.NombreProducto</strong></td>
                                    <td><span class="badge bg-secondary">@product.Categoria</span></td>
                                    <td class="text-center">@product.TotalOpiniones</td>
                                    <td class="text-center">
                                        <span class="badge" style="background: @(product.PromedioSatisfaccion >= 4 ? "#10b981" : product.PromedioSatisfaccion >= 3 ? "#f59e0b" : "#ef4444")">
                                            @product.PromedioSatisfaccion.ToString("0.00")
                                        </span>
                                    </td>
                                    <td class="text-center">@product.PorcentajePositivo.ToString("0.0")%</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Opiniones Recientes -->
    <div class="row">
        <div class="col-12">
            <div class="chart-container">
                <h5 class="chart-title">📝 Opiniones Recientes</h5>
                @foreach (var opinion in Model.DashboardData.RecentOpinions.Take(10))
                {
                    <div class="recent-opinion">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong>@opinion.NombreProducto</strong>
                                <span class="badge bg-secondary ms-2">@opinion.Categoria</span>
                            </div>
                            <div>
                                <span class="badge-@(opinion.Clasificacion == "Positiva" ? "positive" : opinion.Clasificacion == "Negativa" ? "negative" : "neutral")">
                                    @opinion.Clasificacion
                                </span>
                                <span class="ms-2 text-muted">⭐ @opinion.PuntajeSatisfaccion?.ToString("0.0")</span>
                            </div>
                        </div>
                        <p class="mb-2">@opinion.Comentario</p>
                        <small class="text-muted">
                            📅 @opinion.Fecha.ToString("dd/MM/yyyy") |
                            📡 @opinion.NombreFuente
                        </small>
                    </div>
                }
            </div>
        </div>
    </div>

</div>

<!-- Scripts de Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Datos del modelo
    const sentimentData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DashboardData.SentimentDistribution));
    const trendData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DashboardData.MonthlyTrends));
    const sourceData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DashboardData.SourceStats));

    // Gráfico de Pastel - Sentimientos
    new Chart(document.getElementById('sentimentPieChart'), {
        type: 'doughnut',
        data: {
            labels: sentimentData.map(s => s.clasificacion),
            datasets: [{
                data: sentimentData.map(s => s.cantidad),
                backgroundColor: sentimentData.map(s => s.color),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // Gráfico de Línea - Tendencia
    new Chart(document.getElementById('trendLineChart'), {
        type: 'line',
        data: {
            labels: trendData.map(t => t.mesNombre + ' ' + t.año),
            datasets: [
                {
                    label: 'Promedio Satisfacción',
                    data: trendData.map(t => t.promedioSatisfaccion),
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Positivas',
                    data: trendData.map(t => t.positivas),
                    borderColor: '#10b981',
                    tension: 0.4
                },
                {
                    label: 'Negativas',
                    data: trendData.map(t => t.negativas),
                    borderColor: '#ef4444',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'bottom' }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });

    // Gráfico de Barras - Fuentes
    new Chart(document.getElementById('sourceBarChart'), {
        type: 'bar',
        data: {
            labels: sourceData.map(s => s.nombreFuente),
            datasets: [{
                label: 'Opiniones',
                data: sourceData.map(s => s.totalOpiniones),
                backgroundColor: sourceData.map(s => s.color)
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { beginAtZero: true }
            }
        }
    });
</script>